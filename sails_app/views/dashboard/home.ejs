<style type="text/css">
  #map-container {
    width:100%;
    height:350px;
    margin:0px 0px;
  }
  #search-text {
    width:100%;
    height:40px;
  }

  .clickableRow {
    cursor: pointer;
  }
</style>
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="/js/markerclusterer_compiled.js" type="text/javascript"></script>
<script src="/js/markerwithlabel_packed.js" type="text/javascript"></script>
<div class="col-md-12 col-sm-12 col-xs-12">
  <form id="siloPick" class="form-horizontal" role="form">
    <div class="form-group col-sm-3">
        <label class="col-sm-4 control-label">Region</label>
        <div class="input-group col-sm-8">
            <select class="form-control" name="region">
                <option value="*">Any</option>
                <% for (var i in regions) { %>
                  <option value="<%= regions[i].id %>"><%= regions[i].name %></option>
                <% } %>            
            </select>
        </div>
    </div>
    <div class="form-group col-sm-3">
        <label class="col-sm-4 control-label">Product</label>
        <div class="input-group col-sm-8">
            <select class="form-control" name="product">
                <option value="*">Any</option>
                <% for (var i in products) { %>
                  <option value="<%= products[i].id %>"><%= products[i].name %></option>
                <% } %>            
            </select>
        </div>
    </div>
    <div class="form-group col-sm-3">
        <label class="col-sm-4 control-label">Max Silo Level</label>
        <div class="input-group col-sm-8">
          <input name="silo_level" type="text"/>
        </div>
    </div>
    <div class="form-group col-sm-3">
        <a href="javascript:;" class="btn btn-primary btn-lg" id="generateSilos">GO</a>
    </div>
  </form>
</div>
<div class="col-md-12 col-sm-12 col-xs-12">
  <div id="map-container">
  </div>
</div>
<div class="col-md-9 col-sm-9 col-xs-9" style="padding-top:15px;">
  <input id="search-text" type="text" placeholder="Search...">
  <h2>Select a location to view:</h2>
  <table class="table table-hover">
    <thead>
      <th>Name</th>
      <th>Address</th>
      <th>Number of Silos</th>
    </thead>
    <tbody id="farm-list">
    <% for (var i in user_farms) { %>
      <tr class="clickableRow" data-url="/farm/<%= user_farms[i].id %>">
        <td><%= user_farms[i].name %></td>
        <td><%= user_farms[i].address %></td>
        <td><%= user_farms[i].silos.length %></td>
      </tr>
    <% } %>
    </tbody>
  </table>
</div>

<script>
  $(document).ready(function() {
      $(".clickableRow").click(function() {
            window.document.location = $(this).data("url");
      });
  });
  function createMarker(name,type,location,desc,id) {
    var locationArray = location.split(",");
    var marker = new MarkerWithLabel({
      position: new google.maps.LatLng(locationArray[0],locationArray[1]),
      map: map,
      draggable: false,
      raiseOnDrag: false,
      title: name,
      icon: "/images/" + type + ".png",
      // labelContent: "A",
      // labelAnchor: new google.maps.Point(3, 30),
      // labelClass: "labels", // the CSS class for the label
      // labelInBackground: false
    });
    marker.link_id = id;
    marker.asset_type = type;
    var descArray = desc.split("|");
    marker.desc1 = descArray[0];
    marker.desc2 = descArray[1];

    google.maps.event.addListener(marker, 'click', function() {
      map.setZoom(16);
      map.setCenter(this.getPosition());
      infoWindow.setContent("<strong>" + this.getTitle() + "</strong><br/>" + this.desc1 + "<br/>" + this.desc2 + "<br/>" + "<div><a style='font-weight:800;' href='" + this.asset_type + "/" + this.link_id + "'>View Location</a></div>");
      infoWindow.open(map, this);
    });
    markerIndex.push(marker);
  }
  var farms = JSON.parse("<%= JSON.stringify(user_farms) %>".replace(/&quot;/g,'"'));
  var markerIndex = [];
  var mapOptions = {zoom: 6, center: new google.maps.LatLng(43.251678,-79.812285)};
  var map = new google.maps.Map($('#map-container')[0],mapOptions);
  var infoWindow = new google.maps.InfoWindow({
    maxWidth: 200
  });

  for(var farmIndex in farms) {
    var farm = farms[farmIndex];
    for(var index in farm.silos) {
      var silo = farm.silos[index];
      createMarker(silo.name,"silo",silo.location, silo.desc + "|Capacity: " + silo.capacity,silo.id);
    }
    createMarker(farm.name,"farm",farm.location,farm.address,farm.id);
  }
  var mcOptions = { 
    styles: [{ height: 53,url: "http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m1.png",width: 53},
             {height: 56,url: "http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m2.png",width: 56},
             {height: 66,url: "http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m3.png",width: 66},
             {height: 78,url: "http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m4.png",width: 78},
             {height: 90,url: "http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m5.png",width: 90}
            ],
    gridSize: 50,
    maxZoom: 15
  }

  var mc = new MarkerClusterer(map, markerIndex, mcOptions);

  $("#search-text").keyup(function () {
    
    var searchTerm = $("#search-text").val();
    var listItem = $('#farm-list').children('li');
    
    $.extend($.expr[':'], {
      'containsi': function(elem, i, match, array)
      {
        return (elem.textContent || elem.innerText || '').toLowerCase()
        .indexOf((match[3] || "").toLowerCase()) >= 0;
      }
    });

    var searchSplit = searchTerm.replace(/ /g, "'):containsi('");

    $("#farm-list tr").not(":containsi('" + searchSplit + "')").each(function(e)   {
          $(this).css('display','none');
    });
    
    $("#farm-list tr:containsi('" + searchSplit + "')").each(function(e) {
          $(this).css('display','table-row');
    });
  });
</script>
