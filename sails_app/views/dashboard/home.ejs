<style type="text/css">
  #map-container {
    width:100%;
    height:350px;
    margin:0px 0px;
  }
  #search-text {
    width:100%;
  }
</style>
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="/js/markerclusterer_compiled.js" type="text/javascript"></script>
<script src="/js/markerwithlabel_packed.js" type="text/javascript"></script>
<div class="col-md-8 col-sm-8 col-xs-8">
  <div id="map-container">
  </div>
</div>
<div class="col-md-4 col-sm-4 col-xs-4" style="padding-left:25px;">
  <input id="search-text" type="text" placeholder="Search...">
  <h3>Select a location to view:</h3>
  <ul id="dashboard-list">
    <% for (var i in dashboards) { %>
      <li>
        <a href="/dashboard/<%= dashboards[i].id %>"><%= dashboards[i].name %></a>
      </li>
    <% } %>
  </ul>
</div>

<script>    
  function init_map() {
    $.ajax({
      type: "GET",
      url: "/get_children",
      success: function(data) {
        var orgs = JSON.parse(data);

        var markerIndex = [];
        var centerLocation = new google.maps.LatLng(43.251678,-79.812285);
        var mapOptions = {zoom: 6, center: centerLocation};
        var map = new google.maps.Map($('#map-container')[0],mapOptions);
        var infoWindow = new google.maps.InfoWindow({
          maxWidth: 200});

        for(var index in orgs) {
          var location = orgs[index]["location"].split(",");
          var marker = new MarkerWithLabel({
            position: new google.maps.LatLng(location[0],location[1]),
            map: map,
            draggable: false,
            raiseOnDrag: false,
            title:orgs[index]["name"]
            // labelContent: "A",
            // labelAnchor: new google.maps.Point(3, 30),
            // labelClass: "labels", // the CSS class for the label
            // labelInBackground: false
          });
          marker.dashboard_id = orgs[index]["id"];
          var address = orgs[index]["address"].split('|');
          marker.addressline1 = address[0];
          marker.addressline2 = address[1];
          marker.phone_num = orgs[index]["phone_num"];
          google.maps.event.addListener(marker, 'click', function() {
            map.setZoom(16);
            map.setCenter(this.getPosition());
            infoWindow.setContent("<strong>" + this.getTitle() + "</strong><br/>" + this.addressline1 + "<br/>" + this.addressline2 + "<br/>" + this.phone_num + "<div><a style='font-weight:800;' href='/dashboard/" + this.dashboard_id + "'>GO!</a></div>");
            infoWindow.open(map, this);
          });
          markerIndex.push(marker);
        }
        var mcOptions = { 
          styles: [{ height: 53,url: "http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m1.png",width: 53},
                   {height: 56,url: "http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m2.png",width: 56},
                   {height: 66,url: "http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m3.png",width: 66},
                   {height: 78,url: "http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m4.png",width: 78},
                   {height: 90,url: "http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m5.png",width: 90}
                  ],
          gridSize: 50,
          maxZoom: 15
        }
        var mc = new MarkerClusterer(map, markerIndex, mcOptions);
      },
      error: function(response) {
        console.log("Error");
        console.log(response);
      }
    });
  }

  init_map();

  $("#search-text").keyup(function () {
    
    var searchTerm = $("#search-text").val();
    var listItem = $('#dashboard-list').children('li');
    
    $.extend($.expr[':'], {
      'containsi': function(elem, i, match, array)
      {
        return (elem.textContent || elem.innerText || '').toLowerCase()
        .indexOf((match[3] || "").toLowerCase()) >= 0;
      }
    });

    var searchSplit = searchTerm.replace(/ /g, "'):containsi('");

    $("#dashboard-list li").not(":containsi('" + searchSplit + "')").each(function(e)   {
          $(this).css('display','none');
    });
    
    $("#dashboard-list li:containsi('" + searchSplit + "')").each(function(e) {
          $(this).css('display','list-item');
    });
  });
</script>
